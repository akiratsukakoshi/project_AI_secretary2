# RAGアップローダー利用ガイド

## 概要

RAGアップローダーは、gaku-co（ガクコ）AI秘書プロジェクトの検索拡張生成（RAG）システム向けに、ドキュメントを効率的にインデックス化するためのツールです。様々な形式のドキュメントを処理し、適切なチャンキングを行い、Supabaseデータベースに格納します。

## 機能

- **多様なファイル形式のサポート**: JSON、Markdown、テキストファイルを処理
- **インテリジェントなメタデータ生成**: 文書内容から要約、タグ、タイトルを自動抽出
- **高度なチャンキング**: コンテンツタイプに応じた最適分割と構造化メタデータ付与
- **検索最適化**: 各チャンクの検索性能を向上させる拡張情報の追加
- **コンテンツ更新管理**: 既存ドキュメント検出と差分更新
- **コマンドライン操作**: 柔軟なオプション設定と一括処理

## インストール

RAGアップローダーはプロジェクトの一部として既にインストールされています。`/scripts/rag/` ディレクトリに配置されています。

## 使用方法

### 基本的な使い方

```bash
ts-node scripts/rag/upload_documents.ts <フォルダパス> [オプション]
```

このコマンドは指定したフォルダ内のすべてのドキュメントを処理し、RAGシステムにインデックス化します。

### オプション

| オプション | 説明 |
|-----------|------|
| `--source-type, -t <type>` | ドキュメントのソースタイプを指定（デフォルト: `system_info`） |
| `--skip-chunking` | チャンキング処理をスキップ |
| `--verbose, -v` | 詳細なログを表示 |
| `--batch, -b [size]` | バッチ処理を有効化（オプションでサイズ指定） |
| `--delete, -d <id>` | 指定IDのドキュメントを削除 |

### 使用例

#### システム情報ドキュメントのアップロード
```bash
ts-node scripts/rag/upload_documents.ts /path/to/system_docs -t system_info
```

#### FAQ情報のアップロード（詳細ログ付き）
```bash
ts-node scripts/rag/upload_documents.ts /path/to/faq_docs -t faq --verbose
```

#### イベント情報のアップロード（チャンキングなし）
```bash
ts-node scripts/rag/upload_documents.ts /path/to/event_info -t event --skip-chunking
```

#### 特定ドキュメントの削除
```bash
ts-node scripts/rag/upload_documents.ts --delete "document_id_to_delete"
```

## サポートされるファイル形式

### JSON形式

JSONファイルは以下の構造に従うことが期待されます：

```json
{
  "title": "ドキュメントタイトル",
  "content": "ドキュメント本文...",
  "source_type": "system_info",
  "metadata": {
    "summary": "ドキュメントの要約（自動生成も可能）",
    "tags": ["ガイド", "入門", "システム"],
    "document_title": "ドキュメント全体のタイトル"
  }
}
```

### Markdown形式

Markdownファイルは YAML Front Matter をサポートしています：

```markdown
---
title: ドキュメントタイトル
source_type: faq
summary: ドキュメントの簡潔な要約
tags: 
  - よくある質問
  - 使い方
  - 初心者向け
---

# ドキュメントタイトル

ドキュメント本文...
```

Front Matter がない場合：
- 最初の `#` 見出しがタイトルとして抽出されます
- 要約は文書内容から自動生成されます
- タグはコンテンツから自動抽出されます

### テキスト形式

テキストファイル処理時の自動化機能：
- 見出しやコンテンツからタイトルを抽出（見出しがない場合はファイル名を使用）
- 内容から要約を自動生成（先頭300文字または文単位の切り出し）
- キーワードをタグとして自動抽出

## 拡張メタデータ

各チャンクには以下の拡張メタデータが付与されます：

| フィールド | 説明 | 作成方法 |
|-----------|------|---------|
| `title` | チャンクの具体的なタイトル | 見出し抽出または自動生成 |
| `summary` | 内容の要約 | 先頭文から自動生成 |
| `tags` | 検索用キーワード | コンテンツとファイル名から抽出 |
| `source_type` | ドキュメント分類 | 明示的指定またはフォルダ名から推定 |
| `document_title` | 元ドキュメントのタイトル | 元ファイルのタイトル |
| `chunk_index` | ドキュメント内でのチャンク位置 | 自動割り当て |
| `total_chunks` | ドキュメント内の総チャンク数 | 自動計算 |

これらのメタデータは、ベクトル検索やフィルタリングに使用され、検索精度を大幅に向上させます。

## ドキュメントタイプ

RAGシステムでは以下のドキュメントタイプがサポートされています：

- `system_info`: システム情報、使い方ガイドなど
- `faq`: よくある質問
- `event`: イベント情報
- `customer`: 顧客情報
- `meeting_note`: 会議録

各ドキュメントタイプに最適化されたチャンキング処理が適用されます：

| タイプ | チャンキング方法 | 最適用途 |
|-------|-----------------|---------|
| `system_info` | 見出しベース | マニュアル、説明書 |
| `faq` | 見出しベース + Q&A検出 | FAQ、ヘルプ |
| `meeting_note` | 見出しベース + 時系列 | 議事録、ノート |
| `event` | 単一チャンク | イベント情報 |
| `customer` | 単一チャンク | 顧客情報 |

## タグの抽出機能

自動タグ抽出機能は以下の特徴があります：

1. **基本タグ**: ソースタイプを基本タグとして追加
2. **ファイル名タグ**: ファイル名から意味のある単語を抽出
3. **コンテンツタグ**: 本文から特徴的な単語やパターンを抽出
4. **制限**: 最大10個のタグに制限（優先度順）

## 要約生成機能

自動要約生成のプロセス：

1. コンテンツの正規化（改行・空白処理）
2. 文単位での切り出し（自然な区切り）
3. 最大長さの制限（デフォルト300文字）
4. 適切な要約が生成できない場合は先頭部分を切り出し

## 更新と削除

- **更新検出**: ドキュメント内容やメタデータのハッシュ値を比較して変更を検出
- **差分更新**: 変更があった場合のみデータベースを更新
- **チャンク再生成**: 更新時にはすべてのチャンクを再生成
- **削除機能**: ドキュメントとそれに関連するすべてのチャンクを完全に削除

## セキュリティ向上

旧バージョンで含まれていた問題点を改善：

- 絶対ファイルパス情報を削除
- センシティブな情報を含まないファイル名のみを保持
- ローカルシステム情報を取り除いた安全なメタデータ構造

## トラブルシューティング

### よくある問題

1. **ファイルが処理されない**
   - ファイル形式が対応しているか確認（JSON, Markdown, テキスト）
   - ファイルに読み取り権限があるか確認

2. **チャンキングエラー**
   - 大きすぎるファイルの場合は分割を検討
   - `--skip-chunking` オプションを使用して問題を切り分け

3. **更新が反映されない**
   - 同一ドキュメントIDで内容に変更がない場合は更新されません
   - `--verbose` オプションを使用して詳細ログを確認

4. **検索結果の精度が低い**
   - メタデータのタグが適切か確認
   - ドキュメントが適切なsource_typeに分類されているか確認
   - チャンクサイズが適切か（大きすぎ/小さすぎ）

### ログの確認

詳細ログを有効にすることで問題の切り分けが容易になります：

```bash
ts-node scripts/rag/upload_documents.ts /path/to/docs --verbose
```

## 開発者向け情報

このツールは以下のモジュールと連携しています：

- `src/modules/rag/indexer.ts`: ドキュメント・チャンクのインデックス機能
- `src/modules/rag/chunker.ts`: チャンキングロジック
- `src/interfaces/rag.ts`: 型定義
- `src/config/supabase.ts`: Supabase接続

追加機能を実装する場合は、これらのモジュールとの整合性を確保してください。

## 最新の改善点（2025年4月更新）

- メタデータの構造化と強化
- コンテンツからのインテリジェントなタグ抽出
- 自動要約生成機能の追加
- チャンクの関連性情報の追加
- セキュリティ向上（機密パス情報の削除）
