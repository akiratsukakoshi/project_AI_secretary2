/**
 * ã‚¿ã‚¹ã‚¯ç®¡ç†é–¢é€£ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
 * Notionã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å®šç¾©
 */

/**
 * ã‚¿ã‚¹ã‚¯ç®¡ç†é–¢é€£ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
 */
export const taskPrompts = {
  /**
   * ãƒ„ãƒ¼ãƒ«é¸æŠãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
   * @param userQuery ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒª
   * @param availableTools åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ä¸€è¦§
   * @param contextInfo è¿½åŠ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
   * @returns æ§‹ç¯‰ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
   */
  buildToolSelectionPrompt: (
    userQuery: string, 
    availableTools: Array<{
      name: string;
      description: string;
      parameters: Record<string, any>;
    }>,
    contextInfo?: string
  ): string => {
    // ç’°å¢ƒå¤‰æ•°ã®å€¤ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¦å®‰å…¨ã«ä½¿ç”¨
    // å¤‰æ•°ã¨ã—ã¦å‚ç…§ã—ãªã„ã€ç›´æ¥æ–‡å­—åˆ—ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚€
    // æ³¨æ„: ä»¥ä¸‹ã®IDã‚’ç›´æ¥æ–‡å­—åˆ—ã¨ã—ã¦ä½¿ç”¨ã—ã€å¤‰æ•°å‚ç…§ã‚„æ–‡å­—åˆ—å†…ã§ã®å¤‰æ•°å±•é–‹ã¯ã—ãªã„
    const taskDbIdValue = "1d39a1dfe8368135941de579ca166c05"; // ç›´æ¥æ–‡å­—åˆ—å€¤ã‚’ä½¿ç”¨
    const staffDbIdValue = "1d39a1dfe83681cb8daad265d38d1c7e"; // ç›´æ¥æ–‡å­—åˆ—å€¤ã‚’ä½¿ç”¨
    
    const toolDescriptions = availableTools.map(tool => {
      const paramsDescription = Object.entries(tool.parameters).map(
        ([name, desc]) => `    - ${name}: ${desc.description || desc}`
      ).join('\n');
      
      return `- ${tool.name}: ${tool.description}\n  Parameters:\n${paramsDescription}`;
    }).join('\n\n');
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦å®‰å…¨ã«ä½¿ç”¨
    const escapedQuery = userQuery.replace(/[\\$"`]/g, '\\$&');
    
    // å®‰å…¨ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—æ§‹ç¯‰
    let promptText = `
ã‚ãªãŸã¯ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€Œgaku-coï¼ˆã‚¬ã‚¯ã‚³ï¼‰ã€ã®ä¸€éƒ¨ã¨ã—ã¦ã€Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã£ãŸã‚¿ã‚¹ã‚¯ç®¡ç†ã‚’æ‹…å½“ã—ã¦ã„ã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚: "${escapedQuery}"

`;

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’å®‰å…¨ã«è¿½åŠ 
    if (contextInfo) {
      const escapedContext = contextInfo.replace(/[\\$"`]/g, '\\$&');
      promptText += `ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±:\n${escapedContext}\n\n`;
    }
    
    // ãƒ„ãƒ¼ãƒ«æƒ…å ±ã‚’è¿½åŠ 
    promptText += `åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«:\n${toolDescriptions}

ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã‚’å®Ÿç¾ã—ã¦ãã ã•ã„ã€‚
ä¸»ã«ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š

1. ã‚¿ã‚¹ã‚¯ã®å‚ç…§ãƒ»æ¤œç´¢:
   - æ‹…å½“è€…ã€çŠ¶æ…‹ã€æœŸé™æ—¥ãªã©ã§ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢ã§ãã¾ã™
   - ä¾‹: ã€ŒãŒãã¡ã‚‡ãƒ¼ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤ºã—ã¦ã€ã€Œä»Šé€±ç· ã‚åˆ‡ã‚Šã®ã‚¿ã‚¹ã‚¯ã¯ï¼Ÿã€

2. ã‚¿ã‚¹ã‚¯è¿½åŠ :
   - æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã™
   - ã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€æ‹…å½“è€…ã€æœŸé™æ—¥ã€ã‚«ãƒ†ã‚´ãƒªãªã©ã®æƒ…å ±ã‚’è¨­å®šã§ãã¾ã™
   - ä¾‹: ã€Œè­°äº‹éŒ²ä½œæˆã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ã€æ‹…å½“ã¯ã‚¬ã‚¯ãƒãƒ§ã§æœŸé™ã¯é‡‘æ›œæ—¥ã¾ã§ã€

3. ã‚¿ã‚¹ã‚¯æ›´æ–°:
   - æ—¢å­˜ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€æ‹…å½“è€…å¤‰æ›´ãªã©ã‚’è¡Œã„ã¾ã™
   - ä¾‹: ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»æ›¸ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¦ã€

é‡è¦ãªç‚¹:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã®è¨­å®š (éå¸¸ã«é‡è¦): 
  - ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã¯ç›´æ¥ "${taskDbIdValue}" ã“ã®å€¤ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
  - ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã¯ç›´æ¥ "${staffDbIdValue}" ã“ã®å€¤ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
  - taskDbIdã‚„å¤‰æ•°å¼ãªã©ã®å¤‰æ•°åã‚„å¼ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
  - taskDbId()ã®ã‚ˆã†ãªé–¢æ•°å‘¼ã³å‡ºã—ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
  - database_id: taskDbId ã‚„ database_id: taskDbId() ãªã©ã¯çµ¶å¯¾ã«ä½¿ç”¨ã›ãšã€å¿…ãš database_id: "1d39a1dfe8368135941de579ca166c05" ã®ã‚ˆã†ã«ãã®ã¾ã¾ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
  - JSONã®å€¤ã¨ã—ã¦IDã‚’è¨­å®šã™ã‚‹å ´åˆã¯å¸¸ã« "1d39a1dfe8368135941de579ca166c05" ã®ã‚ˆã†ã«ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚“ã§ãã ã•ã„

- æ‹…å½“è€…ã®ç‰¹å®šæ–¹æ³•:
  - æ‹…å½“è€…ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹éš›ã¯ã€æœ¬åï¼ˆä¾‹: "å¡šè¶Šæš"ï¼‰ã§ã¯ãªãå¿…ãšè¡¨ç¤ºåï¼ˆä¾‹: "ã‚¬ã‚¯ãƒãƒ§"ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
  - æœ¬åã‹ã‚‰è¡¨ç¤ºåã¸ã®å¤‰æ›ã«ã¯ã€ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿DBã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
  - queryDatabaseã§ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿DBã‹ã‚‰è¡¨ç¤ºåã‚’å–å¾—ã—ã€ãã‚Œã‚’ã‚¿ã‚¹ã‚¯æ¤œç´¢ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ä½¿ç”¨ã—ã¦ãã ã•ã„

- ã‚¹ã‚¿ãƒƒãƒ•åã®è­˜åˆ¥: "ã‚¬ã‚¯ãƒãƒ§"ã€"ãŒãã¡ã‚‡ãƒ¼"ã€"å¡šè¶Šæš" ãªã©ã®ç•°ãªã‚‹è¡¨è¨˜ã¯åŒã˜äººç‰©ã‚’æŒ‡ã—ã¾ã™
- æ—¥ä»˜ã®è§£é‡ˆ: "æ˜æ—¥"ã€"ä»Šé€±é‡‘æ›œæ—¥"ã€"4/20" ãªã©æ§˜ã€…ãªæ—¥ä»˜è¡¨ç¾ã‚’é©åˆ‡ã«è§£é‡ˆã—ã¦ãã ã•ã„
- å¿…è¦ãªæƒ…å ±ã®ç¢ºèª: ã‚¿ã‚¹ã‚¯è¿½åŠ æ™‚ã«æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã—ã¦ãã ã•ã„

- Notionãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å‹æ§‹é€ ã¨æ­£ç¢ºãªåç§°ï¼ˆé‡è¦ï¼‰:
  - å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã”ã¨ã«æ­£ã—ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ§‹æ–‡ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:
  - ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆtitleå‹ï¼‰: { "property": "ã‚¿ã‚¤ãƒˆãƒ«", "title": { "contains": "è­°äº‹éŒ²" } }
  - èª¬æ˜ï¼ˆrich_textå‹ï¼‰: { "property": "èª¬æ˜", "rich_text": { "contains": "è³‡æ–™ä½œæˆ" } }
  - æœŸé™ï¼ˆdateå‹ï¼‰: { "property": "æœŸé™", "date": { "on_or_after": "2025-04-15" } } - æ­£ç¢ºãªåç§°ã¯ã€ŒæœŸé™æ—¥ã€ã§ã¯ãªãã€ŒæœŸé™ã€ã§ã™
  - çŠ¶æ…‹ï¼ˆselectå‹ï¼‰: { "property": "çŠ¶æ…‹", "select": { "equals": "æœªç€æ‰‹" } } - æœ‰åŠ¹ãªå€¤ã¯ã€Œæœªç€æ‰‹ã€ã€Œé€²è¡Œä¸­ã€ã€Œå®Œäº†ã€ã€Œä¿ç•™ã€ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã®ã¿
  - æ‹…å½“è€…ï¼ˆtextå‹ï¼‰: { "property": "æ‹…å½“è€…", "text": { "equals": "ã‚¬ã‚¯ãƒãƒ§" } }
  
  - "status"ã¨ã„ã†å‹ã¯å­˜åœ¨ã—ãªã„ã®ã§ã€selectå‹ã®çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã¯å¿…ãš"select"ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ãã ã•ã„
  - ã€Œæœªå®Œäº†ã‚¿ã‚¹ã‚¯ã€ã‚’æ¤œç´¢ã™ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ãªORæ¡ä»¶ã®è¤‡åˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:
    \`\`\`
    "filter": {
      "or": [
        { "property": "çŠ¶æ…‹", "select": { "equals": "æœªç€æ‰‹" }},
        { "property": "çŠ¶æ…‹", "select": { "equals": "é€²è¡Œä¸­" }}
      ]
    }
    \`\`\`

ã‚¯ã‚¨ãƒªã®å†…å®¹ã«æœ€é©ãªãƒ„ãƒ¼ãƒ«ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«ã¯ queryDatabase ã‚’ä½¿ç”¨ã—ã€æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆã«ã¯ createPage ã‚’ã€
ã‚¿ã‚¹ã‚¯æ›´æ–°ã«ã¯ updatePage ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

æœ€ã‚‚é‡è¦: ã‚ãªãŸã®å‡ºåŠ›ãŒ JSON ã¨ã—ã¦å®‰å…¨ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã¯å¸¸ã«æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„: "1d39a1dfe8368135941de579ca166c05"
- taskDbId ã‚„ TASK_DB_ID ãªã©ã®å¤‰æ•°åã‚’æ–‡å­—åˆ—ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ã•ãˆé¿ã‘ã¦ãã ã•ã„
- "database_id": "taskDbId" ã®ã‚ˆã†ã«å¤‰æ•°åã‚’æ–‡å­—åˆ—ã¨ã—ã¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã«å«ã‚ã‚‹ã“ã¨ã‚‚é¿ã‘ã¦ãã ã•ã„
- é–¢æ•°å½¢å¼ï¼ˆä¸¸æ‹¬å¼§ã‚’å«ã‚€å½¢å¼ï¼‰ã¯çµ¶å¯¾ã«å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„
- JSONã®å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…ãšæ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã€æ•°å€¤ãƒªãƒ†ãƒ©ãƒ«ã€é…åˆ—ãƒªãƒ†ãƒ©ãƒ«ã€ã¾ãŸã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ†ãƒ©ãƒ«ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å«ã‚ã‚‹ã“ã¨ã‚‚é¿ã‘ã¦ãã ã•ã„

å®‰å…¨ãªå‡ºåŠ›ä¾‹:
{
  "tool": "queryDatabase",
  "parameters": {
    "database_id": "1d39a1dfe8368135941de579ca166c05",
    "filter": { "property": "ã‚¿ã‚¤ãƒˆãƒ«", "title": { "contains": "ä¼šè­°" } }
  }
}

å‡ºåŠ›å½¢å¼: 
{
  "tool": "é¸æŠã—ãŸãƒ„ãƒ¼ãƒ«å",
  "parameters": {
    "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å": "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤",
    ...
  },
  "reasoning": "ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’é¸ã‚“ã ç†ç”±ã¨ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã©ã®ã‚ˆã†ã«æ±ºå®šã—ãŸã‹"
}
`;

    // æœ€çµ‚çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿”ã™
    return promptText;
  },
  
  /**
   * ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   * @param data APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿
   * @param toolType ä½¿ç”¨ã—ãŸãƒ„ãƒ¼ãƒ«ç¨®åˆ¥
   * @returns ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
   */
  formatResponse: (data: any, toolType: string): string => {
    // ãƒ„ãƒ¼ãƒ«ç¨®åˆ¥ã«å¿œã˜ãŸçµæœã®æ•´å½¢ãƒ­ã‚¸ãƒƒã‚¯
    switch (toolType) {
      case 'queryDatabase':
        if (!data || !data.results || data.results.length === 0) {
          return 'æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        }
        
        return formatTaskList(data.results);
        
      case 'createPage':
        try {
          // æ–°è¦ä½œæˆã—ãŸã‚¿ã‚¹ã‚¯ã®æƒ…å ±ã‚’æŠ½å‡º
          const title = getTitle(data);
          const dueDate = getDate(data, 'æœŸé™');
          const assignees = getAssignees(data);
          
          let response = `æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã€Œ${title}ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚`;
          
          // æœŸé™ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
          if (dueDate) {
            response += `\næœŸé™: ${formatDate(new Date(dueDate))}`;
          }
          
          // æ‹…å½“è€…ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
          if (assignees) {
            response += `\næ‹…å½“: ${assignees}`;
          }
          
          return response;
        } catch (error) {
          console.error('ã‚¿ã‚¹ã‚¯ä½œæˆçµæœã®è§£æã‚¨ãƒ©ãƒ¼:', error);
          return `ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸã€‚`;
        }
        
      case 'updatePage':
        try {
          const title = getTitle(data);
          const status = getStatus(data);
          
          let response = `ã‚¿ã‚¹ã‚¯ã€Œ${title}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`;
          
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
          if (status) {
            response += `\nç¾åœ¨ã®çŠ¶æ…‹: ${formatStatus(status)}`;
          }
          
          return response;
        } catch (error) {
          console.error('ã‚¿ã‚¹ã‚¯æ›´æ–°çµæœã®è§£æã‚¨ãƒ©ãƒ¼:', error);
          return `ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`;
        }
        
      case 'retrievePage':
        return formatTaskDetail(data);
        
      case 'deletePage':
        return `ã‚¿ã‚¹ã‚¯ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆå‰Šé™¤ï¼‰ã—ã¾ã—ãŸã€‚`;
        
      default:
        // å®‰å…¨ã®ãŸã‚è©³ç´°ãªãƒ‡ãƒ¼ã‚¿ã¯å‡ºåŠ›ã—ãªã„
        return `æ“ä½œãŒå®Œäº†ã—ã¾ã—ãŸã€‚`;
    }
  },

  /**
   * ã‚¿ã‚¹ã‚¯ç®¡ç†ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   * @param error ã‚¨ãƒ©ãƒ¼æƒ…å ±
   * @returns ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   */
  formatErrorMessage: (error: any): string => {
    // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
    const errorCode = error.code || '';
    const errorMessage = error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

    switch (errorCode) {
      case 'PERMISSION_DENIED':
        return 'Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
      case 'NOT_FOUND':
        return 'æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ­£ã—ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚„IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      case 'INVALID_ARGUMENT':
        return 'å…¥åŠ›æƒ…å ±ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¿ã‚¹ã‚¯ã®è©³ç´°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      default:
        return `ã‚¿ã‚¹ã‚¯æ“ä½œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${errorMessage}`;
    }
  }
};

/**
 * Notionãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
 */
function getTitle(data: any): string {
  try {
    // Notionãƒšãƒ¼ã‚¸ã®ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰æœ€åˆã®ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’å–å¾—
    return data.properties?.['ã‚¿ã‚¤ãƒˆãƒ«']?.title?.[0]?.text?.content || 'ç„¡é¡Œ';
  } catch (e) {
    return 'ç„¡é¡Œ';
  }
}

/**
 * Notionãƒšãƒ¼ã‚¸ã‹ã‚‰æ—¥ä»˜ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–å¾—
 */
function getDate(data: any, propertyName: string): string | null {
  try {
    // Notionãƒšãƒ¼ã‚¸ã®æ—¥ä»˜ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®é–‹å§‹æ—¥ã‚’å–å¾—
    return data.properties?.[propertyName]?.date?.start || null;
  } catch (e) {
    return null;
  }
}

/**
 * Notionãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
 */
function getStatus(data: any): string | null {
  try {
    // Notionãƒšãƒ¼ã‚¸ã®ã€Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰é¸æŠè‚¢ã®åå‰ã‚’å–å¾—
    return data.properties?.['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']?.select?.name || null;
  } catch (e) {
    return null;
  }
}

/**
 * Notionãƒšãƒ¼ã‚¸ã‹ã‚‰æ‹…å½“è€…æƒ…å ±ã‚’å–å¾—
 */
function getAssignees(data: any): string {
  try {
    // Notionãƒšãƒ¼ã‚¸ã®ã€Œæ‹…å½“è€…ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰äººç‰©ãƒªã‚¹ãƒˆã‚’å–å¾—
    const assignees = data.properties?.['æ‹…å½“è€…']?.people || [];
    if (assignees.length === 0) return '';
    
    // å„æ‹…å½“è€…ã®åå‰ã‚’å–å¾—ã—ã¦çµåˆ
    return assignees.map((person: any) => person.name || person.id).join(', ');
  } catch (e) {
    return '';
  }
}

/**
 * Notionãƒšãƒ¼ã‚¸ã‹ã‚‰èª¬æ˜ã‚’å–å¾—
 */
function getDescription(data: any): string {
  try {
    // Notionãƒšãƒ¼ã‚¸ã®ã€Œèª¬æ˜ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’å–å¾—
    const richTexts = data.properties?.['èª¬æ˜']?.rich_text || [];
    if (richTexts.length === 0) return '';
    
    // å„ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ã‚’å–å¾—ã—ã¦çµåˆ
    return richTexts.map((rt: any) => rt.text?.content || '').join('');
  } catch (e) {
    return '';
  }
}

/**
 * Notionãƒšãƒ¼ã‚¸ã‹ã‚‰å„ªå…ˆåº¦ã‚’å–å¾—
 */
function getPriority(data: any): string {
  try {
    // Notionãƒšãƒ¼ã‚¸ã®ã€Œå„ªå…ˆåº¦ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰é¸æŠè‚¢ã®åå‰ã‚’å–å¾—
    return data.properties?.['å„ªå…ˆåº¦']?.select?.name || '';
  } catch (e) {
    return '';
  }
}

/**
 * ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ•´å½¢
 * @param tasks ã‚¿ã‚¹ã‚¯ä¸€è¦§
 * @returns æ•´å½¢ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ä¸€è¦§æ–‡å­—åˆ—
 */
function formatTaskList(tasks: any[]): string {
  let message = `ã‚¿ã‚¹ã‚¯ä¸€è¦§ (${tasks.length}ä»¶):\n\n`;
  
  tasks.forEach((task, index) => {
    // æƒ…å ±æŠ½å‡º
    const title = getTitle(task);
    const dueDate = getDate(task, 'æœŸé™');
    const dueStr = dueDate ? ` (æœŸé™: ${formatDate(new Date(dueDate))})` : '';
    const status = getStatus(task);
    const priority = getPriority(task);
    const priorityMark = getPriorityMark(priority);
    const assignees = getAssignees(task);
    
    // ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
    message += `${index + 1}. ${priorityMark} ${title}${dueStr}\n`;
    
    // æ‹…å½“è€…ã®è¡¨ç¤º
    if (assignees) {
      message += `   æ‹…å½“: ${assignees}\n`;
    }
    
    // çŠ¶æ…‹ãŒæœªç€æ‰‹ä»¥å¤–ã®å ´åˆã¯è¡¨ç¤º
    if (status && status !== 'æœªç€æ‰‹') {
      message += `   çŠ¶æ…‹: ${formatStatus(status)}\n`;
    }
    
    message += '\n';
  });
  
  return message;
}

/**
 * ã‚¿ã‚¹ã‚¯è©³ç´°ã‚’æ•´å½¢
 * @param task ã‚¿ã‚¹ã‚¯æƒ…å ±
 * @returns æ•´å½¢ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯è©³ç´°æ–‡å­—åˆ—
 */
function formatTaskDetail(task: any): string {
  let message = `ã€ã‚¿ã‚¹ã‚¯è©³ç´°ã€‘\n`;
  
  // æƒ…å ±æŠ½å‡º
  const title = getTitle(task);
  const description = getDescription(task);
  const dueDate = getDate(task, 'æœŸé™');
  const priority = getPriority(task);
  const status = getStatus(task);
  const assignees = getAssignees(task);
  
  // ã‚¿ã‚¤ãƒˆãƒ«
  message += `ã‚¿ã‚¤ãƒˆãƒ«: ${title}\n`;
  
  // èª¬æ˜
  if (description) {
    message += `èª¬æ˜: ${description}\n`;
  }
  
  // æœŸé™æ—¥
  if (dueDate) {
    message += `æœŸé™: ${formatDate(new Date(dueDate))}\n`;
  }
  
  // å„ªå…ˆåº¦
  if (priority) {
    message += `å„ªå…ˆåº¦: ${getPriorityMark(priority)} ${priority}\n`;
  }
  
  // ã‚«ãƒ†ã‚´ãƒªã®å–å¾—
  const categories = task.properties?.['ã‚«ãƒ†ã‚´ãƒª']?.relation || [];
  if (categories.length > 0) {
    message += `ã‚«ãƒ†ã‚´ãƒª: ${categories.length}ä»¶ã®ã‚«ãƒ†ã‚´ãƒªãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™\n`;
  }
  
  // æ‹…å½“è€…
  if (assignees) {
    message += `æ‹…å½“: ${assignees}\n`;
  }
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  if (status) {
    message += `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${formatStatus(status)}\n`;
  }
  
  // ä½œæˆæ—¥æ™‚ã¨æ›´æ–°æ—¥æ™‚
  if (task.created_time) {
    message += `ä½œæˆæ—¥æ™‚: ${formatDateTime(new Date(task.created_time))}\n`;
  }
  
  if (task.last_edited_time) {
    message += `æ›´æ–°æ—¥æ™‚: ${formatDateTime(new Date(task.last_edited_time))}\n`;
  }
  
  message += `ID: ${task.id}\n`;
  
  return message;
}

/**
 * å„ªå…ˆåº¦ã«å¿œã˜ãŸãƒãƒ¼ã‚¯ã‚’è¿”ã™
 * @param priority å„ªå…ˆåº¦
 * @returns å„ªå…ˆåº¦ã‚’ç¤ºã™ãƒãƒ¼ã‚¯
 */
function getPriorityMark(priority: string): string {
  switch (priority) {
    case 'é«˜': return 'ğŸ”´';
    case 'ä¸­': return 'ğŸŸ¡';
    case 'ä½': return 'ğŸŸ¢';
    default: return 'âšª';
  }
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ—¥æœ¬èªè¡¨ç¤º
 * @param status ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 * @returns æ—¥æœ¬èªã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 */
function formatStatus(status: string): string {
  switch (status) {
    case 'pending':
    case 'æœªç€æ‰‹': return 'æœªç€æ‰‹';
    case 'in_progress':
    case 'é€²è¡Œä¸­': return 'é€²è¡Œä¸­';
    case 'completed':
    case 'å®Œäº†': return 'å®Œäº†';
    default: return status;
  }
}

/**
 * æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 * @param date æ—¥ä»˜
 * @returns ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ—¥ä»˜æ–‡å­—åˆ—
 */
function formatDate(date: Date): string {
  return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
}

/**
 * æ—¥æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 * @param date æ—¥æ™‚
 * @returns ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ—¥æ™‚æ–‡å­—åˆ—
 */
function formatDateTime(date: Date): string {
  return `${formatDate(date)} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
}