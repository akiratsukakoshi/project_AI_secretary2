import { Message } from 'discord.js';
import logger from '../../../utilities/logger';

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚¯ã‚¨ãƒªã‚’å‡¦ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
 */
class QueryProcessor {
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‰ã‚¯ã‚¨ãƒªã‚’æŠ½å‡º
   * ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã€ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã©ã‚’é™¤å»
   */
  extractQuery(content: string): string {
    // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚„ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’é™¤å»
    let query = content;
    
    // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€Œ\!aiã€ã®é™¤å»
    if (query.startsWith('\!ai')) {
      query = query.slice(3).trim();
    }
    
    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’é™¤å»ï¼ˆDiscord IDãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    query = query.replace(/<@\!?\d+>/g, '').trim();
    
    // ã€Œã‚¬ã‚¯ã‚³ã€ã€ãªã©ã®å‘¼ã³ã‹ã‘ã‚’é™¤å»
    query = query.replace(/^(ã‚¬ã‚¯ã‚³|ãŒãã“|gakuco)(ã€|,|\s+)/i, '').trim();
    
    // ã€Œæ¢ã—ã¦ï¼šã€ã€Œæ•™ãˆã¦ï¼šã€ãªã©ã®ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é™¤å»
    query = query.replace(/^(æ¢ã—ã¦|æ¤œç´¢ã—ã¦|æ•™ãˆã¦|èª¿ã¹ã¦)(ï¼š|:|\s+)/i, '').trim();
    
    logger.debug(`å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${content}`);
    logger.debug(`æŠ½å‡ºã•ã‚ŒãŸã‚¯ã‚¨ãƒª: ${query}`);
    
    return query;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‰ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’æ¤œå‡º
   * @returns ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ— (rag, workflow, conversation)
   */
  detectTriggerType(content: string): 'rag' | 'workflow' | 'conversation' {
    console.log("\nğŸ§  ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šé–‹å§‹:", content);
    logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šé–‹å§‹: " + content);

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’å¼·åŒ–
    console.log("\nğŸ¯ğŸ¯ğŸ¯ detectTriggerType ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ ğŸ¯ğŸ¯ğŸ¯");
    console.log("å…¥åŠ›å†…å®¹å®Œå…¨ç‰ˆ:", content);
    logger.debug("detectTriggerType ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ: " + content);

    // ã™ã¹ã¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰
    console.log("\nğŸ“ ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ãƒ‡ãƒãƒƒã‚° ğŸ“");
    console.log("ã€Œè¨˜æ†¶ã‚’ç¢ºèªã€ãƒãƒƒãƒ:", content.includes('è¨˜æ†¶ã‚’ç¢ºèª') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("ã€Œè¨˜æ†¶ã€ãƒãƒƒãƒ:", content.includes('è¨˜æ†¶') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("ã€Œè­°äº‹éŒ²ã€ãƒãƒƒãƒ:", content.includes('è­°äº‹éŒ²') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("ã€Œä¼šè­°ã€ãƒãƒƒãƒ:", content.includes('ä¼šè­°') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("å…¥åŠ›æ–‡å­—åˆ—å°æ–‡å­—:", content.toLowerCase());

    // æ˜ç¤ºçš„ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼šåˆ¤å®šé–‹å§‹
    console.log("\nğŸ”ğŸ”ğŸ” ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šãƒ—ãƒ­ã‚»ã‚¹è©³ç´° ğŸ”ğŸ”ğŸ”");
    logger.debug("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šãƒ—ãƒ­ã‚»ã‚¹è©³ç´°é–‹å§‹");
    
    // æ˜ç¤ºçš„RAGã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ - æœ€ã‚‚å„ªå…ˆåº¦ã®é«˜ã„ã‚·ãƒ³ãƒ—ãƒ«ãªãƒã‚§ãƒƒã‚¯ï¼ˆå˜ä¸€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰
    const simpleKeywords = ['è¨˜æ†¶', 'è­°äº‹éŒ²', 'ä¼šè­°', 'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°', 'å±¥æ­´', 'æ¤œç´¢'];
    let foundKeyword = null;
    for (const keyword of simpleKeywords) {
      if (content.toLowerCase().includes(keyword)) {
        foundKeyword = keyword;
        break;
      }
    }
    
    if (foundKeyword) {
      console.log(`âœ… ã‚·ãƒ³ãƒ—ãƒ«RAGã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º: "${foundKeyword}"`);
      logger.info(`ã€ã‚·ãƒ³ãƒ—ãƒ«RAGã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºã€‘: "${foundKeyword}"`);
      logger.info(`ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆ"${foundKeyword}"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰`);
      return 'rag';
    }
    
    // æ˜ç¤ºçš„ãªRAGèµ·å‹•ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆæœ€å„ªå…ˆï¼‰
    // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ‹¡å¼µ: ã€Œè¨˜æ†¶ã‚’ç¢ºèªã€ã®å¾Œã®ã€Œã—ã¦ã€ãªã©ã‚‚è€ƒæ…®
    const hasExplicitRagTrigger = content.match(/ã‚¬ã‚¯ã‚³.*è¨˜æ†¶ã‚’ç¢ºèª|ã‚¬ã‚¯ã‚³.*ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª|ã‚¬ã‚¯ã‚³.*è¨˜éŒ²ç¢ºèª|è¨˜æ†¶ã‚’ç¢ºèªã—ã¦|è¨˜æ†¶ã‚’ç¢ºèª|ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª|è¨˜éŒ²ç¢ºèª|æƒ…å ±ã‚’ç¢ºèª|æƒ…å ±ã‚’æ¢|æ¤œç´¢ã—ã¦|å±¥æ­´ã‚’ç¢ºèª|éå»ã®.*ã‚’ç¢ºèª|è­°äº‹éŒ²|ä¼šè­°.*è­°äº‹éŒ²|ä¼šè­°.*è¨˜éŒ²/i);
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼šæ˜ç¤ºçš„RAGãƒˆãƒªã‚¬ãƒ¼
    console.log('æ˜ç¤ºçš„RAGãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ãƒã‚§ãƒƒã‚¯çµæœ:', hasExplicitRagTrigger ? 
      `ãƒãƒƒãƒ: "${hasExplicitRagTrigger[0]}"` : "ãƒãƒƒãƒãªã—");
    logger.debug('æ˜ç¤ºçš„RAGãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ãƒã‚§ãƒƒã‚¯: ' + (hasExplicitRagTrigger ? 
      `ãƒãƒƒãƒ: "${hasExplicitRagTrigger[0]}"` : "ãƒãƒƒãƒãªã—"));
    
    if (hasExplicitRagTrigger) {
      console.log("âœ… æ˜ç¤ºçš„RAGãƒˆãƒªã‚¬ãƒ¼æ¤œå‡º:", hasExplicitRagTrigger[0]);
      logger.info("ã€æ˜ç¤ºçš„RAGãƒˆãƒªã‚¬ãƒ¼æ¤œå‡ºã€‘: " + hasExplicitRagTrigger[0]);
      logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆæ˜ç¤ºçš„ãƒˆãƒªã‚¬ãƒ¼ï¼‰");
      return 'rag';
    }

    // è¿½åŠ : è¨˜æ†¶ãƒ»ä¼šè­°ç‰¹åŒ–ã®ãƒã‚§ãƒƒã‚¯
    const hasMemoryMeetingKeywords = content.match(/è¨˜æ†¶|ä¼šè­°|è­°äº‹éŒ²|ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°|æ‰“ã¡åˆã‚ã›/i);
    console.log('è¨˜æ†¶ãƒ»ä¼šè­°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', hasMemoryMeetingKeywords ? 
      `ãƒãƒƒãƒ: "${hasMemoryMeetingKeywords[0]}"` : "ãƒãƒƒãƒãªã—");
    
    if (hasMemoryMeetingKeywords) {
      console.log("âœ… è¨˜æ†¶ãƒ»ä¼šè­°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º:", hasMemoryMeetingKeywords[0]);
      logger.info("ã€è¨˜æ†¶ãƒ»ä¼šè­°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºã€‘: " + hasMemoryMeetingKeywords[0]);
      logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆè¨˜æ†¶ãƒ»ä¼šè­°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰");
      return 'rag';
    }

    // æ˜ç¤ºçš„ãªRAGæ¤œç´¢ãƒˆãƒªã‚¬ãƒ¼ã®æ¤œå‡ºï¼ˆå‘½ä»¤å½¢ã‚‚å«ã‚ã‚‹ï¼‰
    const hasRagTrigger = content.match(/ã‚¬ã‚¯ã‚³.*æ¢ã—ã¦|æ¤œç´¢ã—ã¦|èª¿ã¹ã¦|ã‚¬ã‚¯ã‚³.*ã«ã¤ã„ã¦|æ¤œç´¢|æ•™ãˆã¦.*æƒ…å ±|èª¿æŸ»|ç¢ºèªã—ã¦|æ•™ãˆã¦|çŸ¥ã‚ŠãŸã„|å…±æœ‰ã—ã¦/i);
    console.log("- RAGãƒˆãƒªã‚¬ãƒ¼æ¤œå‡º:", hasRagTrigger ? `ã‚ã‚Š: "${hasRagTrigger[0]}"` : "ãªã—");
    logger.info("RAGãƒˆãƒªã‚¬ãƒ¼æ¤œå‡º: " + (hasRagTrigger ? `ã‚ã‚Š: "${hasRagTrigger[0]}"` : "ãªã—"));
    
    // æ˜ç¤ºçš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼ã®æ¤œå‡º
    const hasWorkflowTrigger = content.match(/ã‚¬ã‚¯ã‚³.*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼|ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ|ã‚¿ã‚¹ã‚¯ç®¡ç†|ã‚¿ã‚¹ã‚¯è¿½åŠ |ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼|äºˆå®šç®¡ç†|ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š/i);
    console.log("- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼æ¤œå‡º:", hasWorkflowTrigger ? `ã‚ã‚Š: "${hasWorkflowTrigger[0]}"` : "ãªã—");
    logger.info("ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼æ¤œå‡º: " + (hasWorkflowTrigger ? `ã‚ã‚Š: "${hasWorkflowTrigger[0]}"` : "ãªã—"));
    
    // è³ªå•å½¢å¼ã‚’åˆ¤å®šï¼ˆè³ªå•æ–‡ã®ã¿RAGæ¤œç´¢ã¨ã™ã‚‹ã€ä¸€èˆ¬çš„ãªå˜èªã¯å¯¾è±¡å¤–ã«ï¼‰
    const isQuestion = content.match(/[?ï¼Ÿ]$/) || 
                      (content.includes('ã„ã¤') && !content.includes('äºˆå®š')) || 
                      (content.includes('ã©ã“') && !content.includes('ã‚¿ã‚¹ã‚¯')) || 
                      (content.includes('èª°ãŒ') && !content.includes('æ‹…å½“')) || 
                      (content.includes('ä½•ã‚’') && !content.includes('ã‚¿ã‚¹ã‚¯')) ||
                      content.includes('ã©ã‚“ãª') ||
                      content.includes('ã©ã†ã™ã‚Œã°') ||
                      (content.includes('æ•™ãˆã¦') && !content.includes('ã‚¿ã‚¹ã‚¯'));
                      
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼šè³ªå•å½¢å¼ãƒã‚§ãƒƒã‚¯è©³ç´°
    console.log("- è³ªå•å½¢å¼ãƒã‚§ãƒƒã‚¯è©³ç´°:");
    console.log("  - æœ«å°¾ãŒ?/ï¼Ÿ:", content.match(/[?ï¼Ÿ]$/) ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œã„ã¤ã€å«ã‚€:", content.includes('ã„ã¤') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œã©ã“ã€å«ã‚€:", content.includes('ã©ã“') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œèª°ãŒã€å«ã‚€:", content.includes('èª°ãŒ') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œä½•ã‚’ã€å«ã‚€:", content.includes('ä½•ã‚’') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œã©ã‚“ãªã€å«ã‚€:", content.includes('ã©ã‚“ãª') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œã©ã†ã™ã‚Œã°ã€å«ã‚€:", content.includes('ã©ã†ã™ã‚Œã°') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œæ•™ãˆã¦ã€å«ã‚€:", content.includes('æ•™ãˆã¦') ? "ã¯ã„" : "ã„ã„ãˆ");
    
    console.log("- è³ªå•å½¢å¼åˆ¤å®š:", isQuestion ? "è³ªå•å½¢å¼" : "è³ªå•å½¢å¼ã§ã¯ãªã„");
    logger.info("è³ªå•å½¢å¼åˆ¤å®š: " + (isQuestion ? "è³ªå•å½¢å¼" : "è³ªå•å½¢å¼ã§ã¯ãªã„"));

    // ä¼šè­°ã‚„ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º
    // ã€Œç¢ºèªã€ã¨ã€Œä¼šè­°ã€ã®ä¸¡æ–¹ã‚’å«ã‚€ãƒ•ãƒ¬ãƒ¼ã‚ºã¯ä¼šè­°æƒ…å ±æ¤œç´¢ã®è¦æ±‚ã¨åˆ¤æ–­
    const confirmMeeting = 
      (content.includes('ç¢ºèª') || content.includes('æ•™ãˆã¦') || content.includes('èª¿ã¹ã¦') || content.includes('ã‚ã‹ã‚‹')) && 
      (content.includes('ä¼šè­°') || content.includes('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°') || content.includes('æ‰“ã¡åˆã‚ã›') || 
       content.includes('è­°äº‹éŒ²') || content.includes('æ‰“åˆã›') || content.includes('MTG'));
    
    // ä¼šè­°é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    const hasMeetingKeywords = content.includes('ä¼šè­°') || 
                               content.includes('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°') || 
                               content.includes('æ‰“ã¡åˆã‚ã›') ||
                               content.includes('æ‰“åˆã›') ||
                               content.includes('MTG') ||
                               content.includes('è­°äº‹éŒ²');
                               
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼šä¼šè­°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è©³ç´°
    console.log("- ä¼šè­°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è©³ç´°:");
    console.log("  - ã€Œä¼šè­°ã€å«ã‚€:", content.includes('ä¼šè­°') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€ŒãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€å«ã‚€:", content.includes('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œæ‰“ã¡åˆã‚ã›ã€å«ã‚€:", content.includes('æ‰“ã¡åˆã‚ã›') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œè­°äº‹éŒ²ã€å«ã‚€:", content.includes('è­°äº‹éŒ²') ? "ã¯ã„" : "ã„ã„ãˆ");
    console.log("  - ã€Œç¢ºèªã€å«ã‚€:", content.includes('ç¢ºèª') ? "ã¯ã„" : "ã„ã„ãˆ");
    
    console.log("- ä¼šè­°é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:", hasMeetingKeywords ? "ã‚ã‚Š" : "ãªã—");
    console.log("- ä¼šè­°ç¢ºèªãƒ•ãƒ¬ãƒ¼ã‚º:", confirmMeeting ? "ã‚ã‚Š" : "ãªã—");
    logger.info(`ä¼šè­°é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${hasMeetingKeywords ? "ã‚ã‚Š" : "ãªã—"}, ä¼šè­°ç¢ºèªãƒ•ãƒ¬ãƒ¼ã‚º: ${confirmMeeting ? "ã‚ã‚Š" : "ãªã—"}`);
    
    // è©³ç´°ãªåˆ¤å®šãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
    if (hasMeetingKeywords) {
      logger.info(`ä¼šè­°é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º: ${content}`);
    }
    
    if (confirmMeeting) {
      logger.info(`ä¼šè­°ç¢ºèªãƒ•ãƒ¬ãƒ¼ã‚ºæ¤œå‡º: ${content}`);
    }
    
    // æ—¥ä»˜é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º
    const hasDateKeywords = content.match(/(\d+)æœˆ(\d+)æ—¥|ä»Šæ—¥|æ˜æ—¥|æ˜¨æ—¥|å…ˆæ—¥|å…ˆé€±|ä»Šé€±|æ¥é€±/);
    console.log("- æ—¥ä»˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:", hasDateKeywords ? `ã‚ã‚Š (${hasDateKeywords[0]})` : "ãªã—");
    
    // ã‚¿ã‚¹ã‚¯é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    const hasTaskKeywords = content.toLowerCase().includes('ã‚¿ã‚¹ã‚¯') || 
                            content.toLowerCase().includes('todo') || 
                            content.toLowerCase().includes('ã‚„ã‚‹ã“ã¨') ||
                            content.toLowerCase().includes('äºˆå®š');
    console.log("- ã‚¿ã‚¹ã‚¯é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:", hasTaskKeywords ? "ã‚ã‚Š" : "ãªã—");
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼šåˆ¤å®šãƒ—ãƒ­ã‚»ã‚¹ã®ã¾ã¨ã‚
    console.log("\nğŸ§© åˆ¤å®šãƒ—ãƒ­ã‚»ã‚¹ã®ã¾ã¨ã‚:");
    console.log(`- æ˜ç¤ºçš„RAGãƒˆãƒªã‚¬ãƒ¼: ${hasExplicitRagTrigger ? "ã‚ã‚Š" : "ãªã—"}`);
    console.log(`- RAGãƒˆãƒªã‚¬ãƒ¼: ${hasRagTrigger ? "ã‚ã‚Š" : "ãªã—"}`);
    console.log(`- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼: ${hasWorkflowTrigger ? "ã‚ã‚Š" : "ãªã—"}`);
    console.log(`- è³ªå•å½¢å¼: ${isQuestion ? "ã¯ã„" : "ã„ã„ãˆ"}`);
    console.log(`- ä¼šè­°é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${hasMeetingKeywords ? "ã‚ã‚Š" : "ãªã—"}`);
    console.log(`- ä¼šè­°ç¢ºèªãƒ•ãƒ¬ãƒ¼ã‚º: ${confirmMeeting ? "ã‚ã‚Š" : "ãªã—"}`);
    console.log(`- æ—¥ä»˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${hasDateKeywords ? "ã‚ã‚Š" : "ãªã—"}`);
    console.log(`- ã‚¿ã‚¹ã‚¯é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${hasTaskKeywords ? "ã‚ã‚Š" : "ãªã—"}`);
    
    // åˆ¤å®šãƒ—ãƒ­ã‚»ã‚¹ãŒå®Œäº†ã—ãŸã‚‰ã€æœ€çµ‚çš„ãªåˆ¤å®šçµæœã‚’å‡ºåŠ›
    // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’å„ªå…ˆ
    if (hasWorkflowTrigger) {
      console.log("âœ… ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: workflowï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼æ¤œå‡ºï¼‰");
      logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: workflowï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼æ¤œå‡ºï¼‰");
      return 'workflow';
    }

    // æ—¥ä»˜+ã‚¿ã‚¹ã‚¯é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
    if (hasDateKeywords && hasTaskKeywords) {
      console.log("âœ… ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: workflowï¼ˆæ—¥ä»˜+ã‚¿ã‚¹ã‚¯é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºï¼‰");
      logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: workflowï¼ˆæ—¥ä»˜+ã‚¿ã‚¹ã‚¯é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºï¼‰");
      return 'workflow';
    }

    // ä¼šè­°ï¼‹æ—¥ä»˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
    if (hasMeetingKeywords && hasDateKeywords) {
      console.log("âœ… ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆä¼šè­°+æ—¥ä»˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºï¼‰");
      logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆä¼šè­°+æ—¥ä»˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºï¼‰");
      return 'rag';
    }

    // ä¼šè­°æƒ…å ±ã®ç¢ºèªè¦æ±‚ã¯RAGæ¤œç´¢
    if (confirmMeeting) {
      console.log("âœ… ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆä¼šè­°æƒ…å ±ç¢ºèªè¦æ±‚ï¼‰");
      logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆä¼šè­°æƒ…å ±ç¢ºèªè¦æ±‚ï¼‰");
      return 'rag';
    }

    // RAGãƒˆãƒªã‚¬ãƒ¼ãŒã‚ã‚‹å ´åˆ
    if (hasRagTrigger) {
      console.log("âœ… ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆRAGãƒˆãƒªã‚¬ãƒ¼æ¤œå‡ºï¼‰");
      logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆRAGãƒˆãƒªã‚¬ãƒ¼æ¤œå‡ºï¼‰");
      return 'rag';
    }

    // è³ªå•æ–‡ã®å ´åˆã¯RAGæ¤œç´¢
    if (isQuestion) {
      console.log("âœ… ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆè³ªå•å½¢å¼æ¤œå‡ºï¼‰");
      logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: ragï¼ˆè³ªå•å½¢å¼æ¤œå‡ºï¼‰");
      return 'rag';
    }

    // ã©ã‚Œã«ã‚‚å½“ã¦ã¯ã¾ã‚‰ãªã„å ´åˆã¯ä¼šè©±ãƒ¢ãƒ¼ãƒ‰
    console.log("âœ… ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: conversationï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰");
    logger.info("ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—åˆ¤å®šçµæœ: conversationï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰");
    return 'conversation';
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’è§£æã—ã¦æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æŠ½å‡º
   */
  detectSearchFilters(query: string): Record<string, any> {
    const filters: Record<string, any> = {};
    
    // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®æ¤œå‡º
    const dateMatch = query.match(/(ä»Šæ—¥|æ˜æ—¥|æ˜¨æ—¥|ä»Šé€±|å…ˆé€±|æ¥é€±|(\d+)æœˆ(\d+)æ—¥)/);
    if (dateMatch) {
      filters.date = this.parseDate(dateMatch[0]);
    }
    
    // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã®æ¤œå‡º
    if (query.includes('ã§ãã‚‹ã“ã¨') || 
        query.includes('ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼') || 
        query.includes('ä½¿ã„æ–¹') || 
        query.includes('ã‚¬ã‚¯ã‚³') || 
        query.includes('ãŒãã“') || 
        query.includes('æ©Ÿèƒ½')) {
      filters.source_type = 'system_info';
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®æ¤œå‡º
    if (query.includes('ã‚¤ãƒ™ãƒ³ãƒˆ') || 
        query.includes('ãƒ—ãƒ­ã‚°ãƒ©ãƒ ') || 
        query.includes('ã‚»ãƒŸãƒŠãƒ¼') ||
        query.includes('è¬›åº§') ||
        query.includes('ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—')) {
      filters.source_type = 'event';
    }
    
    // ä¼šè­°æƒ…å ±ã®æ¤œå‡º
    if (query.includes('ä¼šè­°') || 
        query.includes('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°') || 
        query.includes('æ‰“ã¡åˆã‚ã›') ||
        query.includes('è­°äº‹éŒ²')) {
      filters.source_type = 'meeting_note';
    }
    
    // é¡§å®¢æƒ…å ±ã®æ¤œå‡º
    if (query.includes('é¡§å®¢') || 
        query.includes('ãŠå®¢æ§˜') || 
        query.includes('å‚åŠ è€…') ||
        query.includes('ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼')) {
      filters.source_type = 'customer';
    }
    
    logger.debug('æ¤œå‡ºã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ' + JSON.stringify(filters));
    
    return filters;
  }

  /**
   * æ—¥ä»˜æ–‡å­—åˆ—ã‚’Dateå‹ã«å¤‰æ›
   */
  private parseDate(dateStr: string): Date {
    const now = new Date();
    
    if (dateStr === 'ä»Šæ—¥') {
      return now;
    }
    
    if (dateStr === 'æ˜æ—¥') {
      const tomorrow = new Date(now);
      tomorrow.setDate(now.getDate() + 1);
      return tomorrow;
    }
    
    if (dateStr === 'æ˜¨æ—¥') {
      const yesterday = new Date(now);
      yesterday.setDate(now.getDate() - 1);
      return yesterday;
    }
    
    if (dateStr === 'ä»Šé€±') {
      return now;
    }
    
    if (dateStr === 'æ¥é€±') {
      const nextWeek = new Date(now);
      nextWeek.setDate(now.getDate() + 7);
      return nextWeek;
    }
    
    if (dateStr === 'å…ˆé€±') {
      const lastWeek = new Date(now);
      lastWeek.setDate(now.getDate() - 7);
      return lastWeek;
    }
    
    // XæœˆYæ—¥ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
    const monthDayMatch = dateStr.match(/(\d+)æœˆ(\d+)æ—¥/);
    if (monthDayMatch) {
      const month = parseInt(monthDayMatch[1]) - 1; // JavaScriptã®æœˆã¯0å§‹ã¾ã‚Š
      const day = parseInt(monthDayMatch[2]);
      
      const date = new Date(now.getFullYear(), month, day);
      
      // æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ãŒéå»ã®å ´åˆã€æ¥å¹´ã®åŒã˜æ—¥ä»˜ã¨è§£é‡ˆ
      if (date < now && (month < now.getMonth() || (month === now.getMonth() && day < now.getDate()))) {
        date.setFullYear(now.getFullYear() + 1);
      }
      
      return date;
    }
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã—ãªã„å ´åˆã¯ç¾åœ¨æ—¥æ™‚ã‚’è¿”ã™
    return now;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
   */
  getUserName(message: Message): string {
    if (message.member?.nickname) {
      return message.member.nickname;
    }
    return message.author.username;
  }
}

export default new QueryProcessor();
